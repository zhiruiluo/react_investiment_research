# Cost & Token Usage Analysis Tool

## Overview
The cost analysis tool tracks token consumption and financial costs across all API calls in the research agent. It provides visibility into LLM token usage, costs per query, and cumulative spending to enable budget management and cost optimization.

## Key Metrics Tracked

### Token Usage
- **Input tokens**: Prompt tokens sent to LLM (market data + query)
- **Output tokens**: Response tokens generated by LLM (thesis bullets + risks)
- **Total tokens**: Combined input + output tokens per request
- **Tokens per ticker**: Normalized token usage by ticker count

### Cost Metrics
- **Per-request cost**: USD cost of a single query inference
- **Per-ticker cost**: Cost normalized by number of tickers analyzed
- **Cumulative cost**: Total spending across all requests in a session
- **Cost by provider**: OpenAI vs Anthropic breakdown

### LLM Model Pricing (as of Feb 2026)
**OpenAI gpt-4o-mini:**
- Input: $0.15 per 1M tokens
- Output: $0.60 per 1M tokens

**Anthropic Claude 3.5 Sonnet:**
- Input: $3.00 per 1M tokens
- Output: $15.00 per 1M tokens

## Usage

### Track a Single Query
```python
from react_investment_research.cost_analyzer import CostAnalyzer

analyzer = CostAnalyzer()

# Run agent with cost tracking
result = analyzer.run_with_tracking(
    agent=agent,
    query="compare AAPL vs MSFT",
    tickers=["AAPL", "MSFT"],
    period="3mo"
)

# Get cost summary
print(analyzer.get_summary())
# Output:
# {
#   "tokens": {"input": 1250, "output": 340, "total": 1590},
#   "cost": {"total_usd": 0.3142, "per_ticker": 0.157},
#   "provider": "openai",
#   "model": "gpt-4o-mini"
# }
```

### Batch Analysis with Cost Reporting
```python
from react_investment_research.cost_analyzer import CostAnalyzer, batch_analyze

queries = [
    ("compare AAPL vs MSFT", ["AAPL", "MSFT"]),
    ("evaluate sector performance", ["SPY", "QQQ"]),
    ("dividend stocks analysis", ["JNJ", "PG", "KO"]),
]

batch_results = batch_analyze(queries, num_workers=1)
print(f"Total queries: {batch_results['total_queries']}")
print(f"Total cost: ${batch_results['total_cost_usd']:.4f}")
print(f"Avg cost/query: ${batch_results['avg_cost_per_query']:.4f}")
print(f"Tokens breakdown:\n{batch_results['tokens_summary']}")
```

### CLI Integration
```bash
# Run query with cost reporting
python -m react_investment_research --use-llm \
  --query "compare AAPL vs MSFT" \
  --tickers AAPL,MSFT \
  --period 3mo \
  --report-cost

# Output includes:
# "cost_analysis": {
#   "tokens": {"input": 1250, "output": 340, "total": 1590},
#   "cost_usd": 0.3142,
#   "provider": "openai",
#   "model": "gpt-4o-mini"
# }
```

## Cost Structure Breakdown

### Typical Query Costs

**Single Ticker (1 ticker, 3mo period):**
- Tool calls: 2 (market_snapshot + fundamentals_events) - no cost
- LLM inference: ~800 input + 250 output tokens
- **Estimated cost: $0.14 USD**

**Comparison Query (2 tickers, 3mo period):**
- Tool calls: 4 (2 per ticker) - no cost
- LLM inference: ~1,600 input + 350 output tokens
- **Estimated cost: $0.27 USD**

**Sector Analysis (5 tickers, 6mo period):**
- Tool calls: 10 (2 per ticker) - no cost
- LLM inference: ~3,500 input + 400 output tokens
- **Estimated cost: $0.62 USD**

### Monthly Budget Estimates
- **Low usage** (5 queries/day): ~$20/month
- **Medium usage** (20 queries/day): ~$150/month
- **High usage** (50 queries/day): ~$400/month

## Output Schema

```json
{
  "query": "compare AAPL vs MSFT",
  "tickers": ["AAPL", "MSFT"],
  "summary": {...},
  "data_used": [...],
  "tool_calls": [...],
  "limitations": [...],
  "disclaimer": "Research summary, not financial advice.",
  "cost_analysis": {
    "tokens": {
      "input": 1250,
      "output": 340,
      "total": 1590
    },
    "cost": {
      "total_usd": 0.3142,
      "breakdown": {
        "input_cost_usd": 0.1875,
        "output_cost_usd": 0.2040
      }
    },
    "provider": "openai",
    "model": "gpt-4o-mini"
  }
}
```

## Analysis Commands

### View session costs
```bash
python -m react_investment_research.cost_analyzer --session
```

### Generate cost report
```bash
python -m react_investment_research.cost_analyzer --report --output report.json
```

### Compare provider costs
```bash
python -m react_investment_research.cost_analyzer --compare-providers
# Output: Cost comparison OpenAI vs Anthropic for typical queries
```

## Integration Points

1. **LLMClient** - Captures token count from API response metadata
2. **ResearchAgent** - Passes cost data to final output
3. **CLI** - Adds --report-cost flag for optional cost injection
4. **CostAnalyzer** - Central tracking and reporting module

## Future Improvements

- Rate limiting based on daily/monthly budget
- Cost prediction before query execution
- Caching layer to reduce repeated LLM calls
- Multi-provider comparison in real-time
- Cost optimization recommendations per query
